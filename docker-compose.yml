services:
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  agentlink:
    build: .
    image: agentlink
    restart: always
    env_file: .env
    ports:
      - "8000:8000"
    environment:
      DOMAIN_API_KEY: ${DOMAIN_API_KEY}
      DOMAIN_API_SECRET: ${DOMAIN_API_SECRET}
      DROPBOX_APP_SECRET: ${DROPBOX_APP_SECRET}
      DROPBOX_APP_KEY: ${DROPBOX_APP_KEY}
      DROPBOX_ACCESS_TOKEN: ${DROPBOX_ACCESS_TOKEN}
      DROPBOX_REFRESH_TOKEN: ${DROPBOX_REFRESH_TOKEN}
      REDIS_URL: redis://redis:6379/0
      USE_BACKBLAZE: ${USE_BACKBLAZE}
      B2_ENDPOINT_URL: ${B2_ENDPOINT_URL}
      B2_KEY_ID: ${B2_KEY_ID}
      B2_APPLICATION_KEY: ${B2_APPLICATION_KEY}
      B2_BUCKET_NAME: ${B2_BUCKET_NAME}
    volumes:
      - ./app/templates:/app/app/templates
      - ./app/assets:/app/app/assets
      - ./app:/app/app
    depends_on:
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Worker 1 - Parallel Processing
  agentlink-worker-1:
    image: agentlink
    restart: always
    env_file: .env
    environment:
      DOMAIN_API_KEY: ${DOMAIN_API_KEY}
      DOMAIN_API_SECRET: ${DOMAIN_API_SECRET}
      DROPBOX_APP_SECRET: ${DROPBOX_APP_SECRET}
      DROPBOX_APP_KEY: ${DROPBOX_APP_KEY}
      DROPBOX_ACCESS_TOKEN: ${DROPBOX_ACCESS_TOKEN}
      DROPBOX_REFRESH_TOKEN: ${DROPBOX_REFRESH_TOKEN}
      REDIS_URL: redis://redis:6379/0
      USE_BACKBLAZE: ${USE_BACKBLAZE}
      B2_ENDPOINT_URL: ${B2_ENDPOINT_URL}
      B2_KEY_ID: ${B2_KEY_ID}
      B2_APPLICATION_KEY: ${B2_APPLICATION_KEY}
      B2_BUCKET_NAME: ${B2_BUCKET_NAME}
    volumes:
      - ./app/templates:/app/app/templates
      - ./app/assets:/app/app/assets
      - ./app:/app/app
    command: rq worker --url redis://redis:6379/0 agentlink-queue
    depends_on:
      - redis

  # Worker 2 - Parallel Processing
  agentlink-worker-2:
    image: agentlink
    restart: always
    env_file: .env
    environment:
      DOMAIN_API_KEY: ${DOMAIN_API_KEY}
      DOMAIN_API_SECRET: ${DOMAIN_API_SECRET}
      DROPBOX_APP_SECRET: ${DROPBOX_APP_SECRET}
      DROPBOX_APP_KEY: ${DROPBOX_APP_KEY}
      DROPBOX_ACCESS_TOKEN: ${DROPBOX_ACCESS_TOKEN}
      DROPBOX_REFRESH_TOKEN: ${DROPBOX_REFRESH_TOKEN}
      REDIS_URL: redis://redis:6379/0
      USE_BACKBLAZE: ${USE_BACKBLAZE}
      B2_ENDPOINT_URL: ${B2_ENDPOINT_URL}
      B2_KEY_ID: ${B2_KEY_ID}
      B2_APPLICATION_KEY: ${B2_APPLICATION_KEY}
      B2_BUCKET_NAME: ${B2_BUCKET_NAME}
    volumes:
      - ./app/templates:/app/app/templates
      - ./app/assets:/app/app/assets
      - ./app:/app/app
    command: rq worker --url redis://redis:6379/0 agentlink-queue
    depends_on:
      - redis

  # Worker 3 - Parallel Processing
  agentlink-worker-3:
    image: agentlink
    restart: always
    env_file: .env
    environment:
      DOMAIN_API_KEY: ${DOMAIN_API_KEY}
      DOMAIN_API_SECRET: ${DOMAIN_API_SECRET}
      DROPBOX_APP_SECRET: ${DROPBOX_APP_SECRET}
      DROPBOX_APP_KEY: ${DROPBOX_APP_KEY}
      DROPBOX_ACCESS_TOKEN: ${DROPBOX_ACCESS_TOKEN}
      DROPBOX_REFRESH_TOKEN: ${DROPBOX_REFRESH_TOKEN}
      REDIS_URL: redis://redis:6379/0
      USE_BACKBLAZE: ${USE_BACKBLAZE}
      B2_ENDPOINT_URL: ${B2_ENDPOINT_URL}
      B2_KEY_ID: ${B2_KEY_ID}
      B2_APPLICATION_KEY: ${B2_APPLICATION_KEY}
      B2_BUCKET_NAME: ${B2_BUCKET_NAME}
    volumes:
      - ./app/templates:/app/app/templates
      - ./app/assets:/app/app/assets
      - ./app:/app/app
    command: rq worker --url redis://redis:6379/0 agentlink-queue
    depends_on:
      - redis

  # Worker 4 - Parallel Processing (Optimal for 8-10 concurrent requests)
  agentlink-worker-4:
    image: agentlink
    restart: always
    env_file: .env
    environment:
      DOMAIN_API_KEY: ${DOMAIN_API_KEY}
      DOMAIN_API_SECRET: ${DOMAIN_API_SECRET}
      DROPBOX_APP_SECRET: ${DROPBOX_APP_SECRET}
      DROPBOX_APP_KEY: ${DROPBOX_APP_KEY}
      DROPBOX_ACCESS_TOKEN: ${DROPBOX_ACCESS_TOKEN}
      DROPBOX_REFRESH_TOKEN: ${DROPBOX_REFRESH_TOKEN}
      REDIS_URL: redis://redis:6379/0
      USE_BACKBLAZE: ${USE_BACKBLAZE}
      B2_ENDPOINT_URL: ${B2_ENDPOINT_URL}
      B2_KEY_ID: ${B2_KEY_ID}
      B2_APPLICATION_KEY: ${B2_APPLICATION_KEY}
      B2_BUCKET_NAME: ${B2_BUCKET_NAME}
    volumes:
      - ./app/templates:/app/app/templates
      - ./app/assets:/app/app/assets
      - ./app:/app/app
    command: rq worker --url redis://redis:6379/0 agentlink-queue
    depends_on:
      - redis

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - /etc/letsencrypt:/etc/letsencrypt
    depends_on:
      - agentlink

volumes:
  redis-data: